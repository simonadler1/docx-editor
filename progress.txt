# Progress Log

## 2026-02-01: Fix alignment button selectors

**Problem:** E2e tests for alignment were failing because the selectors in `e2e/helpers/editor-page.ts` didn't match the actual aria-labels on the alignment buttons.

**Root Cause:** The test selectors used lowercase labels like `[aria-label="Align left"]` but the actual AlignmentButtons component generates aria-labels that include the label from the ALIGNMENT_OPTIONS array plus keyboard shortcuts, e.g., `"Align Left (Ctrl+L)"`.

**Solution:** Updated the alignment button selectors in `e2e/helpers/editor-page.ts`:
- `alignLeft()`: Changed from `[aria-label="Align left"]` to `[aria-label="Align Left (Ctrl+L)"]`
- `alignCenter()`: Changed from `[aria-label="Align center"]` to `[aria-label="Center (Ctrl+E)"]`
- `alignRight()`: Changed from `[aria-label="Align right"]` to `[aria-label="Align Right (Ctrl+R)"]`
- `alignJustify()`: Changed from `[aria-label="Justify"]` to `[aria-label="Justify (Ctrl+J)"]`

**Files Modified:**
- `e2e/helpers/editor-page.ts` - Updated alignment button selectors

**Verification:**
- `npx playwright test --grep "align text left" --timeout=30000` - alignment.spec.ts test passed
- 18 of 29 alignment tests now pass (remaining failures are due to unrelated issues like undo/redo, formatting application)

---

## 2026-02-01: Fix backwards text rendering

**Problem:** Text typed in the editor appeared reversed ("Hello" â†’ "olleH").

**Root Cause:** When users typed in a contentEditable span, the browser would insert characters at the cursor position, but when React re-rendered the component with the new text content, the cursor position was reset to the beginning of the element. Each subsequent keystroke was then inserted at position 0, resulting in reversed text.

**Solution:** Added cursor position preservation in `src/components/edit/EditableRun.tsx`:
1. Added `cursorPositionRef` to track cursor position before state updates
2. In `handleInput` and `handleCompositionEnd`, save the current cursor offset before calling `onChange`
3. Added `useLayoutEffect` to restore the cursor position after React re-renders

**Files Modified:**
- `src/components/edit/EditableRun.tsx` - Added cursor position save/restore logic

**Verification:**
- `npx playwright test --grep "apply bold via toolbar" --timeout=30000` - 2 tests passed
- Manual testing confirmed text now displays correctly

---

## 2026-02-01: Fix bold formatting application

**Problem:** Clicking the bold button didn't apply font-weight: bold to selected text. The toolbar button state would change (showing pressed), but the actual text styling was not updated.

**Root Cause:** The `getSelectionRange()` function in `src/components/AIEditor.tsx` was incorrectly calculating character offsets when the selection's anchor/focus node was an Element (not a Text node). This happens with triple-click selections where the browser may set the anchor/focus to the SPAN element with child-index offsets instead of text-node character offsets.

Example of the bug:
- Selection: "Toggle bold" (11 chars, offset 0-11 in text)
- `selection.anchorNode` = SPAN element, `selection.anchorOffset` = 0 (first child)
- `selection.focusNode` = SPAN element, `selection.focusOffset` = 1 (after first child)
- The old code added the text length (11) to these offsets, producing range 11-12
- This range was PAST the end of the text, so `executeCommand` did nothing

**Solution:** Updated `calculateOffset()` in `src/components/AIEditor.tsx` to handle Element nodes:
1. Detect when node.nodeType === Node.ELEMENT_NODE
2. When offset=0, find the first text node and use offset 0
3. When offset >= childNodes.length, find the last text node and use its length
4. For mid-position offsets, sum character lengths of preceding children

**Files Modified:**
- `src/components/AIEditor.tsx` - Fixed calculateOffset() to handle Element node selections

**Verification:**
- `npx playwright test --grep "apply bold via toolbar" --timeout=30000` - 2 tests passed
- formatting.spec.ts shows 13 passed (up from previous runs where bold tests failed)

---

## 2026-02-01: Fix italic formatting and combined formatting (bold + italic)

**Problem:** Clicking bold button would apply bold to text, but clicking italic immediately after would not apply italic. Combined formatting tests like "bold + italic" were failing.

**Root Cause:** When applying formatting (e.g., bold), the document state changes and React re-renders the component tree. This replaces the DOM nodes, but the browser's Selection object still references the OLD nodes that no longer exist in the document. When the italic button is clicked, `getSelectionRange()` finds no valid selection because the selection's anchor/focus nodes are orphaned.

**Solution:** Implemented selection restoration using document coordinates:

1. Added `onMouseDown` handler to `ToolbarButton` with `e.preventDefault()` to prevent toolbar buttons from stealing focus from the editor
2. Added `restoreSelection(paragraphIndex, startOffset, endOffset)` method to `EditorRef` interface
3. In `Editor.tsx`, implemented `restoreSelection` using:
   - `requestAnimationFrame()` to wait for browser paint
   - `setTimeout(0)` after RAF to ensure we're in a new macrotask after React render
   - TreeWalker to find text nodes and calculate correct DOM offsets
   - Range/Selection API to recreate the selection
4. In `DocxEditor.tsx`, call `restoreSelection` after `handleDocumentChange` to restore the selection after formatting changes
5. Increased test wait times in `editor-page.ts` from 50ms to 100ms to account for async selection restore

**Key Insight:** The timing of when to restore the selection is critical. `setTimeout(0)` alone isn't enough because React may batch state updates. Using `requestAnimationFrame + setTimeout(0)` ensures we wait for both the browser paint and React's render cycle to complete.

**Files Modified:**
- `src/components/Editor.tsx` - Added restoreSelection method to EditorRef
- `src/components/DocxEditor.tsx` - Call restoreSelection after format changes
- `src/components/Toolbar.tsx` - Added onMouseDown preventDefault to ToolbarButton
- `e2e/helpers/editor-page.ts` - Increased wait times to 100ms

**Verification:**
- `npx playwright test --grep "apply italic via toolbar" --timeout=30000` - 2 tests passed
- `npx playwright test --grep "bold + italic" --timeout=30000` - 4 tests passed (combined formatting now works)
